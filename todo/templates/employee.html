<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <title>Employee</title>
    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.6), rgba(0, 0, 0, 0.6)), url('https://wallpapercave.com/wp/wp7881177.jpg');
            background-size: cover;
            background-attachment: fixed;
            background-repeat: no-repeat;

        }

        h2 {

            display: inline-block;
            /* Make the paragraph display as an inline block */
            margin-right: 20px;
            color: white;
        }

        /* Style the Change Password link */
        a.change-password {
            display: inline-block;
            padding: 10px 15px;
            background-color: #990000;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            margin-right: 10px;
        }

        a.completed-tasks {
            display: inline-block;
            padding: 10px 15px;
            background-color: #009900;
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            margin-right: 10px;
        }

        a.change-password:hover {
            background-color: #cc0000;
        }

        a.completed-tasks:hover {
            background-color: #006600;
        }

        a.expired-tasks {
            display: inline-block;
            padding: 10px 15px;
            background-color: rgb(222, 52, 222);
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            margin-right: 10px;
        }

        a.expired-tasks:hover {
            background-color: purple;
        }


        /* Style the Logout button */
        form.logout {
            display: flex;
            align-items: center;
            /* Align items vertically in the center */
            justify-content: flex-end;
            margin-top: -40px;

        }

        button.logout-btn {
            margin-right: 0px;
            padding: 10px 15px;
            background-color: red;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button.logout-btn:hover {
            background-color: rgba(232, 37, 37, 0.943);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 12px;
            text-align: left;
            vertical-align: top;
            /* Align content at the top of cells */
        }

        th {
            background: #007bff;
            color: black;
        }

        td {
            background: #f5f5f5;
        }

        .completed {
            text-decoration: line-through;
        }

        
    </style>
    <script>
        



        function toggleCommentForm(taskId) {
            var commentDiv = document.getElementById('comment-' + taskId);
            var commentFormDiv = document.getElementById('comment-form-' + taskId);
            var editBtn = document.getElementById('edit-btn-' + taskId);

            if (commentDiv.style.display === 'none') {
                commentDiv.style.display = 'block';
                commentFormDiv.style.display = 'none';
                editBtn.style.display = 'block';
            } else {
                commentDiv.style.display = 'none';
                commentFormDiv.style.display = 'block';
                editBtn.style.display = 'none';
            }
        }


        function toggleCommentForm1(sid) {
            var commentDiv = document.getElementById('comment-' + sid);
            var commentFormDiv = document.getElementById('comment-form-' + sid);
            var editBtn = document.getElementById('edit-btn-' + sid);

            if (commentDiv.style.display === 'none') {
                commentDiv.style.display = 'block';
                commentFormDiv.style.display = 'none';
                editBtn.style.display = 'block';
            } else {
                commentDiv.style.display = 'none';
                commentFormDiv.style.display = 'block';
                editBtn.style.display = 'none';
            }
        }

        function toggleTitleForm(sid) {
            var titleDiv = document.getElementById('title-' + sid);
            var titleFormDiv = document.getElementById('title-form-' + sid);
            var editBtn = document.getElementById('edit-title-btn-' + sid);

            if (titleDiv.style.display === 'none') {
                titleDiv.style.display = 'block';
                titleFormDiv.style.display = 'none';
                editBtn.style.display = 'block';
            } else {
                titleDiv.style.display = 'none';
                titleFormDiv.style.display = 'block';
                editBtn.style.display = 'none';
            }
        }

        function markAsCompleted(button, username, task_id, sid) {
    var row = button.parentNode.parentNode;

    // Update completion status in the database
    fetch(`/mark_subtask_completed/${username}/${task_id}/${sid}`, {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        // Handle the JSON response
        if (data.completed) {
            // If the subtask is completed, add 'completed' class to the row
            row.classList.add('completed');

            // Disable all buttons in the row
            var buttons = row.getElementsByTagName('button');
            for (var i = 0; i < buttons.length; i++) {
                buttons[i].disabled = true;
            }

            // If all subtasks are completed, prompt the user
            if (data.all_subtasks_completed) {
                var confirmClose = confirm('Do you want to close the main task?All your subtasks are completed');
                if (confirmClose) {
                    // Redirect to the employee page
                    window.location.href = `/employee/${username}`;
                }
            }
        }
    })
    .catch(error => console.error('Error:', error));
}

// New function to update task_status dynamically
function updateTaskStatus(taskId, timeLeftStatus) {
    // Add conditions to update task_status based on timeLeftStatus
    if (timeLeftStatus === "Past Due") {
        console.log(`Task ${taskId} is expired. Updating status...`);
        $(`#task-status-${taskId}`).text("expired");

        // Update task_status in the database
        $.ajax({
            url: `/update_status/${taskId}`,
            method: 'POST',
            data: { task_status: 'expired' },
            success: function (response) {
                console.log(`Task ${taskId} status updated in the database.`);
            },
            error: function (error) {
                console.error('Error updating task status in the database:', error);
            }
        });
    } else {
        // Add other conditions if needed
    }
}

// Add a variable to track if the page has been reloaded
let pageReloaded = false;

// Function to update task information
function updateTaskInfo(taskId) {
    $.ajax({
        url: `/get_task_info/${taskId}`,
        method: 'GET',
        success: function (data) {
            // Update the corresponding elements with new data
            $(`#time-left-${taskId}`).text(data.time_left);

            // Update task_status dynamically based on time_left_status
            updateTaskStatus(taskId, data.time_left_status);

            // Check if the task_status is "expired" and update the HTML
            if (data.task_status === "expired") {
                console.log(`Task ${taskId} is expired. Updating status...`);
                $(`#task-status-${taskId}`).text("expired");
                $(`#time-left-status-${taskId}`).text("Past Due")

                // Reload the page only if it hasn't been reloaded yet
                if (!pageReloaded) {
                    location.reload(true);
                    pageReloaded = true; // Set the flag to true after reloading
                }
                // You may want to update the database here as well
            }

            // Update #time-left-status-${taskId} with both text and emoji
            var emojiHtml = ''; // Initialize emoji HTML
            if (data.time_left_status == "Less than 1 day") {
                emojiHtml = '&#128308;'; // Unicode for green circle emoji
            } else if (data.time_left_status == "Less than 7 days") {
                emojiHtml = '&#x1F7E0;'; // Unicode for orange circle emoji
            } else {
                emojiHtml = '&#x1F7E2;'; // Unicode for another emoji or adjust as needed
            }

            // Update #time-left-status-${taskId} with both text and emoji
            $(`#time-left-status-${taskId}`).html(`${data.time_left_status} ${emojiHtml}`);
        },
        error: function (error) {
            console.error('Error fetching task info:', error);
        }
    });
}

// Call updateTaskInfo for each task immediately
{% for task in tasks %}
    updateTaskInfo({{ task.task_id }});
{% endfor %}

// Periodically update task info (e.g., every 60 seconds)
setInterval(function () {
    {% for task in tasks %}
        updateTaskInfo({{ task.task_id }});
    {% endfor %}
}, 1000);  // 60 seconds


    



        





    </script>



</head>

<body>

    <h2>Welcome, {{ username }}!</h2>
    <!-- Logout button form -->
    <form action="{{ url_for('logout') }}" method="post" class="logout">
        <button type="submit" class="logout-btn">Logout</button>
    </form>

    {% with messages = get_flashed_messages() %}
    {% if messages %}
    <ul>
        {% for message in messages %}
        <li style="color: {% if 'error' in message %}red{% else %}white{% endif %};">{{ message }}</li>
        {% endfor %}
    </ul>
    {% endif %}
    {% endwith %}
    <a href="{{ url_for('changepassword',username=username) }}" class="change-password">Change Password</a>
    <a href="{{ url_for('viewCompleted',username=username) }}" class="completed-tasks">View Completed Tasks</a>
    <a href="{{ url_for('viewExpired',username=username) }}" class="expired-tasks">View Expired Tasks</a>
    <br><br>
    <h2>Your pending tasks..</h2>
    <table border="1">
        <thead>
            <tr>
                <th>Task ID</th>
                <th>Description</th>
                <th>Status</th>
                <th>Due Date</th>
                <th>Time left</th>
                <th>Symbol</th>
                <th>Priority</th>
                <th>Comment</th>
                <th>Add Subtask</th>
                <th>Close Main Task</th>
            </tr>
        </thead>
        <tbody>
            {% for task in tasks %}
            <tr>
                <td>{{ task.task_id }}</td>
                <td>{{ task.task_desc }}</td>
                <td id="task-status-{{ task.task_id }}">{{ task.task_status }}</td>

                <td id="dueDate_{{ task.task_id }}">{{ task.due_date }}</td>
                <td id="time-left-{{ task.task_id }}">{{ task.time_left }}</td>
                <td id="time-left-status-{{ task.task_id }}" data-task-id="{{ task.task_id }}">
                    {{ task.time_left_status }}
                    {% if task.time_left_status == "Less than 1 day" %}
                        &#128308; <!-- Unicode for green circle emoji -->
                    {% elif task.time_left_status == "Less than 7 days" %}
                        &#128994; <!-- Unicode for orange circle emoji -->
                    {% else %}
                        &#128994; <!-- Unicode for another emoji or adjust as needed -->
                    {% endif %}
                </td>
                
                


                <td>{{ task.priority }}</td>
                <td>
                    <div id="comment-{{ task.task_id }}">{# Display current comment #}
                        {{ task.comment }}
                    </div>

                    <div id="comment-form-{{ task.task_id }}" style="display: none;">{# Comment form initially hidden #}
                        <form method="post"
                            action="{{ url_for('update_comment', username=username, task_id=task.task_id) }}">
                            <input type="text" name="comment" value="{{ task.comment }}" placeholder="Update Comment">
                            <button type="submit">Update Comment</button>
                        </form>
                    </div>

                    <button id="edit-btn-{{ task.task_id }}"
                        onclick="toggleCommentForm({{ task.task_id }})">Edit</button>
                </td>

                <td>
                    <form method="post" action="{{ url_for('add_subtask', username=username, task_id=task.task_id) }}">
                        <input type="text" name="subtask_title" placeholder="Add Subtask" required>


                        <br>
                        <br>
                        <label for="priority">Priority:</label>
                        <select name="priority" required>
                            <option value="High">High</option>
                            <option value="Medium">Medium</option>
                            <option value="Low">Low</option>
                            <option value="Critical">Critical</option>
                        </select>
                        <br><br>
                        <button type="submit">Add Subtask</button>
                    </form>
                    <br>
                </td>
                <td>
                    <form method="post"
                        action="{{ url_for('update_task_status', username=username, task_id=task.task_id) }}">
                        <label for="closeTask">Close Main Task</label>
                        <input type="checkbox" id="closeTask" name="closeTask">
                        <input type="submit" value="Submit">
                    </form>
                </td>


            </tr>

            <tr>
                {% if task.subtasks %}
                <td colspan="7"> <!-- Span across all columns -->
                    <table border="1">
                        <thead>
                            <tr>

                                <th>Description</th>
                                <th>Status</th>
                                <th>Due Date</th>
                                <th>Priority</th>
                                <th>Comments</th>
                                <th>Edit Status</th>

                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for subtask in task.subtasks %}
                            <tr class="{% if subtask.completed %}completed{% endif %}">
                                <td>
                                    <div id="title-{{ subtask.sid }}">{{ subtask.title }}</div>
                                    <div id="title-form-{{ subtask.sid }}" style="display: none;">
                                        <form method="post"
                                            action="{{ url_for('edit_subtask_title', username=username, task_id=task.task_id, sid=subtask.sid) }}">
                                            <input type="text" name="title" value="{{ subtask.title }}"
                                                placeholder="Edit Description">
                                            <button type="submit">Update Title</button>
                                        </form>
                                    </div>
                                    <button id="edit-title-btn-{{subtask.sid}}"
                                        onclick="toggleTitleForm({{ subtask.sid }})" {% if subtask.completed
                                        %}disabled{% endif %}>Edit</button>
                                </td>
                                <td>{{ subtask.subtask_status }}</td>
                                <td>{{ task.due_date }}</td>
                                <td>{{ subtask.priority }}</td>
                                <td>
                                    <div id="comment-{{ subtask.sid }}">{{ subtask.comments }}</div>
                                    <div id="comment-form-{{ subtask.sid }}" style="display: none;">
                                        <form method="post"
                                            action="{{ url_for('edit_subtask_comment', username=username, task_id=task.task_id, sid=subtask.sid) }}">
                                            <input type="text" name="comment" value="{{ subtask.comments }}"
                                                placeholder="Edit Comment">
                                            <button type="submit">Update Comment</button>
                                        </form>
                                    </div>
                                    <button id="edit-btn-{{subtask.sid}}"
                                        onclick="toggleCommentForm1({{ subtask.sid }})" {% if subtask.completed
                                        %}disabled{% endif %}>Edit</button>
                                </td>
                                <td>
                                    {% if subtask.subtask_status == 'pending' %}
                                    <button
                                        onclick="markAsCompleted(this, '{{ username }}', {{ task.task_id }}, {{ subtask.sid }})">Complete</button>
                                    {% else %}
                                    Completed
                                    {% endif %}
                                </td>

                                <td>
                                    <form method="post"
                                        action="{{ url_for('delete_subtask', username=username, task_id=task.task_id,sid=subtask.sid) }}">
                                        <button type="submit" {% if subtask.completed %}disabled{% endif
                                            %}>Delete</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </td>
            </tr>
            {%endif%}
            {% endfor %}
        </tbody>
    </table>

</body>

</html>